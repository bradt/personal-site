var prepare_remove_all_files,remove_files_recursive,prepare_determine_media,determine_media_to_migrate_recursive,remote_media_files_unavailable=!1,remote_connection_data,connection_info,media_successfully_determined,finalise_media_migration;!function(a){var b=0;Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},a(document).ready(function(){function c(g){if(0===Object.size(g.files_to_migrate))return 0===g.total_size?f(0,0,0):e(g),delete g.files_to_migrate,delete g.total_size,next_step_in_migration={fn:determine_media_to_migrate_recursive,args:[g]},void execute_next_step();var h=[],i=0,j=0;if(a.each(g.files_to_migrate,function(a,c){if("push"===wpmdb_migration_type()&&c>b){var d=wpmdbmf_strings.file_too_large+" "+a+" (#124mf)<br>";non_fatal_errors+=d}else if(h.length){if(i+c>g.bottleneck||j>=remote_connection_data.media_files_max_file_uploads)return!1;h.push(a),i+=c}else h.push(a),i+=c;delete g.files_to_migrate[a],++g.media_progress_image_number,++j}),migration_error)return void migration_complete_events();if(!h.length)return e(g),next_step_in_migration={fn:c,args:[g]},void execute_next_step();var k=a.trim(a(".pull-push-connection-info").val()).split("\n");a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_migrate_media",file_chunk:h,remote_uploads_url:g.remote_uploads_url,intent:wpmdb_migration_type(),url:k[0],key:k[1],nonce:wpmdb_data.nonces.migrate_media},error:function(b,c,d){a(".progress-title").html(wpmdbmf_strings.migration_failed),a(".progress-text").not(".media").html(wpmdbGetAjaxErrors(wpmdbmf_strings.problem_migrating_media,"(#102mf)",b.responseText,b)),a(".progress-text").not(".media").addClass("migration-error"),console.log(b),console.log(c),console.log(d),migration_error=!0,migration_complete_events()},success:function(b){var f=b;return(b=wpmdb_parse_json(a.trim(b)))?"undefined"!=typeof b.wpmdb_error&&1===b.wpmdb_error?void d(b.body):("undefined"!=typeof b.wpmdb_non_fatal_error&&1===b.wpmdb_non_fatal_error&&(non_fatal_errors+=b.body),g.media_progress+=i,e(g),next_step_in_migration={fn:c,args:[g]},void execute_next_step()):void d(f)}})}function d(b){a(".progress-title").html(wpmdbmf_strings.migration_failed),a(".progress-text").not(".media").html(wpmdbGetAjaxErrors("","",b)),a(".progress-text").not(".media").addClass("migration-error"),a(".media-progress").fadeOut(),migration_error=!0,migration_complete_events()}function e(a){var b=100*a.media_progress/a.total_size,c=b/100*a.total_files;f(b,Math.round(c),a.total_files)}function f(b,c,d){var e=Math.floor(b),f="migrate_media_files_"+wpmdb_migration_type();a(".media.progress-text").html(e+"% - "+wpmdbmf_strings[f]);var g="%";0===b&&(g="px"),a(".media.progress-bar").width(b+g);var h="";d>0&&(h+="<span>"+wpmdbmf_strings.media_files+' (<span class="">'+wpmdb_add_commas(c)+"</span> / "+wpmdb_add_commas(d)+")</span>"),a(".media.progress-tables").html('<div title="" style="width: 100%;" class="progress-chunk media_files">'+h+"</div>")}function g(){return"1"===a("#media-files").attr("data-available")&&a("#media-files").is(":checked")?!0:!1}function h(b){a(b).is(":checked")&&"entire"===a(b).val()?(a("#remove-local-media").prop("disabled",!0),a("#remove-local-media").prop("checked",!1)):a("#remove-local-media").prop("disabled",!1)}"savefile"===wpmdb_migration_type()&&a(".media-files-options").hide();var i=function(){a("#media-files").attr("data-available","0"),a("#media-files").prop("checked",!1),a("#media-files").attr("disabled","disabled"),a(".media-files").addClass("disabled"),a(".media-files-options .expandable-content").hide()},j=function(b){var c=wpmdb_migration_type();return"savefile"===c?void a(".media-files-options").hide():(a(".media-files-options").show(),a(".media-files-push").hide(),b?(a(".media-files-options ul").hide(),a(".media-migration-unavailable").show(),void i()):"undefined"!=typeof remote_connection_data&&wpmdb_data.media_files_version!==remote_connection_data.media_files_version?(a(".media-files-remote-location").html(remote_connection_data.url),a(".media-file-remote-version").html(remote_connection_data.media_files_version),a(".media-files-different-plugin-version-notice").show(),void i()):(a(".media-files-options ul").show(),a(".media-migration-unavailable").hide(),a(".media-files-different-plugin-version-notice").hide(),a("#media-files").removeAttr("disabled"),a(".media-files").removeClass("disabled"),void a("#media-files").attr("data-available","1")))};a.wpmdb.add_action("move_connection_info_box",function(){j(remote_media_files_unavailable),wpmdb_toggle_migration_action_text()}),a.wpmdb.add_action("verify_connection_to_remote_site",function(a){remote_connection_data=a,remote_media_files_unavailable="undefined"==typeof a.media_files_available,j(remote_media_files_unavailable)}),a.wpmdb.add_filter("wpmdb_before_migration_complete_hooks",function(a){return!1===g()||"savefile"===wpmdb_migration_type()?a:(a.push("prepare_remove_all_files"),a)}),prepare_remove_all_files=function(){connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n");var b=a('input[name="media_migration_option"]:checked').val();if(a(".progress-tables").empty(),a(".progress-tables-hover-boxes").empty(),a(".progress-bar").width("0px"),"compare"!==b){var c="removing_all_files_"+wpmdb_migration_type();a(".progress-text").not(".media").html(wpmdbmf_strings[c]);var d={};d.remove_files=1,d.compare=0,d.offset=0,d.next_step_in_migration="prepare_determine_media",next_step_in_migration={fn:remove_files_recursive,args:[d]},execute_next_step()}else next_step_in_migration={fn:prepare_determine_media},execute_next_step()},remove_files_recursive=function(b){if(0===b.remove_files)return void(!1!==b.next_step_in_migration?(next_step_in_migration={fn:window[b.next_step_in_migration]},execute_next_step()):wpmdb_call_next_hook());connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n");var c=b;a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_remove_files_recursive",compare:b.compare,offset:b.offset,intent:wpmdb_migration_type(),url:connection_info[0],key:connection_info[1],nonce:wpmdb_data.nonces.remove_files_recursive},error:function(b,c,d){a(".progress-title").html(wpmdbmf_strings.migration_failed),a(".progress-text").html(wpmdbGetAjaxErrors(wpmdbmf_strings.error_determining,"(#101mf)",b.responseText,b)),a(".progress-text").addClass("migration-error"),console.log(b),console.log(c),console.log(d),migration_error=!0,migration_complete_events()},success:function(e){var f=e;return(b=wpmdb_parse_json(a.trim(e)))?"undefined"!=typeof b.wpmdb_error&&1===b.wpmdb_error?void d(b.body):("undefined"!=typeof b.wpmdb_non_fatal_error&&1===b.wpmdb_non_fatal_error&&(non_fatal_errors+=b.body),b.next_step_in_migration=c.next_step_in_migration,next_step_in_migration={fn:remove_files_recursive,args:[b]},void execute_next_step()):void d(f)}})},prepare_determine_media=function(){connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n"),b=0;var c=0,e=0,f=a('input[name="media_migration_option"]:checked').val();a(".progress-tables").empty(),a(".progress-tables").html('<div title="'+wpmdbmf_strings.media_files+'" style="width: 100%;" class="progress-chunk media_files"><span></div>'),a(".progress-text").not(".media").html("0% - "+wpmdbmf_strings.determining),"compare"===f?a("#remove-local-media").is(":checked")&&(c=1):e=1;var g={};a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_prepare_determine_media",intent:wpmdb_migration_type(),url:connection_info[0],key:connection_info[1],temp_prefix:connection_data.temp_prefix,nonce:wpmdb_data.nonces.prepare_determine_media},error:function(b,c,d){a(".progress-title").html(wpmdbmf_strings.migration_failed),a(".progress-text").html(wpmdbGetAjaxErrors(wpmdbmf_strings.error_determining,"(#101mf)",b.responseText,b)),a(".progress-text").addClass("migration-error"),console.log(b),console.log(c),console.log(d),migration_error=!0,migration_complete_events()},success:function(f){var h=f;return(g=wpmdb_parse_json(a.trim(f)))?"undefined"!=typeof g.wpmdb_error&&1===g.wpmdb_error?void d(g.body):(b=g.remote_max_upload_size,g.determine_progress=0,g.remove_local_media=c,g.copy_entire_media=e,a(".progress-tables").html('<div title="'+wpmdbmf_strings.media_attachments+'" style="width: 100%;" class="progress-chunk media_files"><span>'+wpmdbmf_strings.media_attachments+' (<span class="">0</span> / '+wpmdb_add_commas(g.attachment_count)+")</span></div>"),next_step_in_migration={fn:determine_media_to_migrate_recursive,args:[g]},void execute_next_step()):void d(h)}})},determine_media_to_migrate_recursive=function(b){return b.determine_progress===b.attachment_count?(a(".media-progress").hide(),a(".progress-bar").width("0px"),a(".progress-tables").empty(),next_step_in_migration={fn:finalise_media_migration,args:[b]},void execute_next_step()):(connection_info=a.trim(a(".pull-push-connection-info").val()).split("\n"),void a.ajax({url:ajaxurl,type:"POST",dataType:"text",cache:!1,data:{action:"wpmdbmf_determine_media_to_migrate_recursive",determine_progress:b.determine_progress,attachment_count:b.attachment_count,remote_uploads_url:b.remote_uploads_url,remove_local_media:b.remove_local_media,copy_entire_media:b.copy_entire_media,prefix:b.prefix,blogs:b.blogs,attachment_batch_limit:b.attachment_batch_limit,intent:wpmdb_migration_type(),url:connection_info[0],key:connection_info[1],temp_prefix:connection_data.temp_prefix,nonce:wpmdb_data.nonces.determine_media_to_migrate_recursive},error:function(b,c,d){a(".progress-title").html(wpmdbmf_strings.migration_failed),a(".progress-text").not(".media").html(wpmdbmf_strings.error_determining+" (#101mf)"),a(".progress-text").not(".media").addClass("migration-error"),console.log(b),console.log(c),console.log(d),migration_error=!0,migration_complete_events()},success:function(c){var e=c;if(c=wpmdb_parse_json(a.trim(c)),!c)return void d(e);if("undefined"!=typeof c.wpmdb_error&&1===c.wpmdb_error)return void d(c.body);b.blogs=c.blogs,b.determine_progress=c.determine_progress,b.total_size=c.total_size,b.files_to_migrate=c.files_to_migrate;var f=100*b.determine_progress/b.attachment_count,g=Math.floor(f);a(".progress-bar").not(".media").width(f+"%"),a(".progress-text").not(".media").html(g+"% - "+wpmdbmf_strings.determining),a(".progress-tables").not(".media").html('<div title="'+wpmdbmf_strings.media_attachments+'" style="width: 100%;" class="progress-chunk media_files"><span>'+wpmdbmf_strings.media_attachments+' (<span class="">'+wpmdb_add_commas(b.determine_progress)+"</span> / "+wpmdb_add_commas(b.attachment_count)+")</span></div>"),next_step_in_migration={fn:media_successfully_determined,args:[b]},execute_next_step()}}))},media_successfully_determined=function(b){return"undefined"!=typeof b.wpmdb_error&&1===b.wpmdb_error?(non_fatal_errors+=data.body,next_step_in_migration={fn:wpmdb_call_next_hook},void execute_next_step()):(b.media_progress=0,b.media_progress_image_number=0,b.bottleneck=wpmdb_data.max_request,b.total_files=Object.size(b.files_to_migrate),a(".media-progress").show(),f(0,0,b.total_files),next_step_in_migration={fn:c,args:[b]},void execute_next_step())},finalise_media_migration=function(b){if(1===b.remove_local_media){var c="removing_files_"+wpmdb_migration_type();return a(".progress-text").not(".media").html(wpmdbmf_strings[c]),b={},b.remove_files=1,b.compare=1,b.offset="",b.next_step_in_migration=!1,next_step_in_migration={fn:remove_files_recursive,args:[b]},void execute_next_step()}wpmdb_call_next_hook()},a('input[name="media_migration_option"]').each(function(){h(this)}),a('input[name="media_migration_option"]').change(function(){h(this)})})}(jQuery);